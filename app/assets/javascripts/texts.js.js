// Generated by CoffeeScript 1.6.2
$(document).ready(function() {
  var element, oldOffset, setRange;

  oldOffset = 0;
  setRange = function(event, highlight) {
    var endset, mecabAjax, mechAjax, offset, range, textNode, words;

    if (document.caretPositionFromPoint) {

    } else if (document.caretRangeFromPoint) {
      console.log("oldOffset: " + oldOffset);
      range = document.caretRangeFromPoint(event.pageX, event.pageY);
      textNode = range.startContainer;
      offset = range.startOffset;
      if (offset !== oldOffset) {
        oldOffset = offset;
        endset = offset + 10;
        range.setStart(textNode, offset);
        range.setEnd(textNode, endset);
        words = range.toString();
      }
    }
    highlight = function(range, mecabresponse, mechresponse) {
      var new_end, sel;

      if (response.offset_add !== 0) {
        new_end = response.offset_add + offset;
        range.setEnd(textNode, new_end);
        sel = window.getSelection();
        sel.removeAllRanges();
        return sel.addRange(range);
      }
    };
    mecabAjax = function(range, words) {
      return $.ajax({
        url: '/search',
        data: {
          query: words
        },
        type: "POST",
        success: function(mecabResp) {
          if (mecabResp.word === false) {
            console.log("negative from mecab");
            return 0;
          } else {
            return mechAjax(range, mecabResp);
          }
        }
      });
    };
    return mechAjax = function(range, mecabResp) {
      return $.ajax({
        url: '/dic',
        data: {
          query: mecabResp.word
        },
        type: "POST",
        success: function(mechResp) {
          if (mechResp.code === 0) {
            console.log("nothing from yahoo");
            return 0;
          } else {
            return highlight(range, mecabResp, mechResp);
          }
        }
      });
    };
  };
  element = document.getElementById("content");
  return element.addEventListener('mousemove', setRange, true);
});
