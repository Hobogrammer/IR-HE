// Generated by CoffeeScript 1.6.2
$(document).ready(function() {
  var element, oldOffset, setRange;

  oldOffset = 0;
  setRange = function(event, highlight) {
    var endset, offset, range, textNode, words;

    if (document.caretPositionFromPoint) {

    } else if (document.caretRangeFromPoint) {
      console.log("oldOffset: " + oldOffset);
      range = document.caretRangeFromPoint(event.pageX, event.pageY);
      textNode = range.startContainer;
      offset = range.startOffset;
      if (offset !== oldOffset) {
        oldOffset = offset;
        endset = offset + 10;
        range.setStart(textNode, offset);
        range.setEnd(textNode, endset);
        words = range.toString();
        $.ajax({
          url: '/search',
          data: {
            query: words
          },
          type: "POST",
          success: function(resp) {
            var test;

            if (resp.code === 0) {
              console.log("Nothing found");
              return 0;
            } else if (resp.code === 2) {
              test = resp.offset_add;
              console.log("Highlighted: " + resp.query + "   Additional Offset: " + resp.offset_add + "   Definition: " + resp.def);
              return highlight(range, resp);
            }
          }
        });
      }
    }
    return highlight = function(range, response) {
      var new_end, sel;

      if (response.offset_add !== 0) {
        new_end = response.offset_add + offset;
        range.setEnd(textNode, new_end);
        sel = window.getSelection();
        sel.removeAllRanges();
        return sel.addRange(range);
      }
    };
  };
  element = document.getElementById("content");
  return element.addEventListener('mousemove', setRange, true);
});
